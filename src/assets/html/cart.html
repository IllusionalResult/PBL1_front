<!DOCTYPE HTML>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="pragma" content="no-cache" />
<meta http-equiv="cache-control" content="max-age=604800" />
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author" content="Bootstrap-ecommerce by Vosidiy">

<title>カート</title>

<!-- jQuery -->
<script src="../js/bootstrap_js/jquery-2.0.0.min.js" type="text/javascript"></script>

<!-- Bootstrap4 files-->
<script src="../js/bootstrap_js/bootstrap.bundle.min.js" type="text/javascript"></script>
<link href="../css/bootstrap_css/bootstrap.css" rel="stylesheet" type="text/css"/>

<!-- Font awesome 5 -->
<link href="../fonts/bootstrap_fonts/fontawesome/css/fontawesome-all.min.css" type="text/css" rel="stylesheet">

<!-- custom style -->
<link href="../css/bootstrap_css/ui.css" rel="stylesheet" type="text/css"/>
<link href="../css/bootstrap_css/responsive.css" rel="stylesheet" media="only screen and (max-width: 1200px)" />

<!-- custom javascript -->
<script src="../js/bootstrap_js/script.js" type="text/javascript"></script>

<script type="text/javascript">
/// some script

// jquery ready start
$(document).ready(function() {
	// jQuery code

});
// jquery end
</script>
</head>
<body>

	<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
	<script src="../js/apiRequest.js"></script>

<header class="section-header">
	<nav class="navbar navbar-top navbar-expand-lg navbar-dark bg-secondary">
		<div class="container">
			<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
				<span class="navbar-toggler-icon"></span>
			</button>
			<div class="collapse navbar-collapse" id="navbarNav">
				<ul class="navbar-nav">
					<li class="nav-item active">
						<a class="nav-link" href="#">Home <span class="sr-only">(current)</span></a>
					</li>
					<li class="nav-item dropdown">
						<a class="nav-link  dropdown-toggle" href="#" data-toggle="dropdown">  Dropdown  </a>
						<ul class="dropdown-menu">
							<li><a class="dropdown-item" href="#"> Menu item 1</a></li>
							<li><a class="dropdown-item" href="#"> Menu item 2 </a></li>
						</ul>
					</li>
				</ul>
			</div>
		</div> <!-- container //  -->
	</nav>
	<section class="header-main shadow">
		<div class="container">
			<div class="row align-items-center">
				<div class="col-lg-3 col-sm-4">
					<div class="brand-wrap">
						<img class="logo" src="../images/icon.png">
						<!--<h2 class="logo-text">LOGO</h2>-->
					</div> <!-- brand-wrap.// -->
				</div>
				<div class="col-lg-6 col-sm-8">
					<form action="#" class="search-wrap">
						<div class="input-group w-100">
							<input type="text" class="form-control" style="width:55%;" placeholder="Search">
							<select class="custom-select"  name="category_name">
								<option value="条件なし">条件なし</option>
								<option value="和食">和食</option>
								<option value="洋食">洋食</option>
								<option value="中華">中華</option>
								<option value="その他">その他</option>
							</select>
							<div class="input-group-append">
								<button class="btn btn-primary" type="submit">
									<i class="fa fa-search"></i>
								</button>
							</div>
						</div>
					</form> <!-- search-wrap .end// -->
				</div> <!-- col.// -->

				<a href="cart.html" class="widget-header mr-3">
					<div class="icontext">
						<div class="icon-wrap"><i class="icon-sm round border fa fa-shopping-cart"></i></div>
						<div class="text-wrap">
							<span class="small badge badge-danger">0</span>
							<div>Cart</div>
						</div>
					</div>
				</a>
			</div> <!-- row.// -->
		</div> <!-- container.// -->
	</section> <!-- header-main .// -->
	</header> <!-- section-header.// -->

<!-- ========================= SECTION CONTENT ========================= -->
<section class="section-content bg padding-y border-top">
<div class="container">

<div class="row">
	<main class="col-sm-9">

		<div id="cart_card"></div>

	</main> <!-- col.// -->
	<aside class="col-sm-3">

<dl class="dlist-align h4">
  <dt>合計：</dt>
  <dd class="text-right"><strong><div id="sum_price">Ｐ</div></strong></dd>
</dl>
<hr>
<dl class="dlist-align h4">
  <dt>合計：</dt>
  <dd class="text-right"><strong><div id="sum_point">円</div></strong></dd>
</dl>
<hr>
<dl class="dlist-align h4">
  <button type="button" onclick="" class="btn btn-lg btn-primary btn-block text-uppercase">購入する</button>
</dl>

	</aside> <!-- col.// -->
</div>

</div> <!-- container .//  -->
</section>

<script>
		var user_id='goya';
		cart_apiURI = 'http://54.238.92.95:8080/api/v1/carts/users/' + user_id;
		recipe_apiURI = 'http://54.238.92.95:8080/api/v1/carts/recipe-counts';
		food_apiURI = 'http://54.238.92.95:8080/api/v1/carts/food-counts';

		window.onload = function load_cart() {
			apiResponse('GET',cart_apiURI,'','',function(data){
				console.log(data);
				var sum_price = 0;
				var sum_point = 0;
				var cart = '';
				var recipe_num = 0;
				data.forEach(function( recipe ){
					var recipe_name = recipe.recipe_name;
					var recipe_image_url = recipe.recipe_image_url;
					var recipe_count = recipe.recipe_count;
					var recipe_price = recipe.price * recipe_count;
					var recipe_point = recipe.point * recipe_count;
					var recipe_id = recipe.recipe_id;
					eval('recipe_foods' + recipe_id + '=recipe.foods;');

							cart += '<div class="card" id="recipe'+ recipe_id +'"><table class="table table-hover shopping-cart-wrap"><thead class="text-muted"><tr>';
					cart += '<th scope="col"  width="350">レシピ'+ (recipe_num + 1) +'</th>';
							cart += '<th scope="col"</th><th scope="col"></th><th scope="col" class="text-right"></th></tr></thead><tbody><tr><td><figure class="media">';
					cart += '<div class="img-wrap"><img src='+ recipe_image_url +' class="img-thumbnail img-sm"></div>';
							cart += '<figcaption class="media-body"><h5 class="title text-truncate">';
					cart += '<div id="recipe_name">'+ recipe_name +'</div><!-- レシピ名 -->';
							cart += '</h5><dl class="dlist-inline small"><dt>　金額　: </dt><dd>';
					cart += '<div id="recipe_price">'+ recipe_price +'</div><!-- レシピ金額 -->';
							cart += '</dd></dl><dl class="dlist-inline small"><dt>ポイント: </dt><dd>';
					cart += '<div id="recipe_point">'+ recipe_point +'</div><!-- レシピポイント -->';
							cart += '</dd></dl></figcaption></figure></td>';

					cart += '<td><h5>'+ recipe_count +'人前</h5></td>';
					cart += '<td><div class="input-group"><select id="recipe_select'+ recipe_id +'">';
					for (var i = 0 ; i <= 5 ; i++) {
						if (i == recipe_count) {
							cart += '<option value="'+ i +'" selected>'+ i +'</option>';
						}else{''
							cart += '<option value="'+ i +'">'+ i +'</option>';
						}
					}
					cart += '</select><div class="input-group-append">';
					cart += '<button class="btn btn-primary" type="submit"';
					cart += 'onclick="change_recipe_counts('+ recipe_id +')">';
		      cart += '<a>数量変更</a></button></div></div></td></tr>';

					var ingredient_num = 0;
					eval('recipe_foods' + recipe_id).forEach(function( ingredient ){
						var food_id = ingredient.food_id;
						var food_count = ingredient.food_count;
						var recipe_item_Ingredients = ingredient.food_name;
						var recipe_item_quantity = ingredient.food_quantity;
									cart += '<div id="ingredients'+ ingredient_num +'"><td class="text-muted"><div class="price-wrap"><var class="text-muted">';
							cart += '<div id="recipe_item_quantity">'+ '　・　' + recipe_item_Ingredients +'</div>';
									cart += '</var></div></td><td><div class="price-wrap"><var class="text-muted">';
							cart += '<div id="recipe_item_quantity">'+ recipe_item_quantity +'　×　'+ food_count +'</div>';
									cart += '</var></div></td><td class="text-right"><var class="text-muted" >';

							cart += '<td><div class="input-group"><select id="food_select'+ recipe_id +'_'+ food_id +'">';
						for (var j = 0 ; j <= recipe_count ; j++) {
							if (j == food_count) {
								cart += '<option value="'+ j +'" selected>'+ j +'</option>';
							}else{
								cart += '<option value="'+ j +'">'+ j +'</option>';
							}
						}
						cart += '</select></div></td></tr>';
						
						sum_point += (recipe_count - food_count) * 10;
						ingredient_num += 1;
					});

					cart += '<tr><td colspan="3"></td><td><button class="btn btn-primary" type="submit"onclick="change_food_counts('+ recipe_id +')">';
					cart += '<a>数量変更</a>';
					cart += '</button></td></tr>';
					/*cart += '<tr><td><div class="input-group-append">';
					cart += '<button class="btn btn-primary" type="submit"onclick="change_food_counts('+ recipe_id +')"><a>数量変更</a></button>';
					cart += '</div></td></tr>';*/

					cart += '</tbody></table><a><br></a></div>';
					sum_price +=	recipe_price;
					sum_point +=	recipe_point;
					recipe_num += 1;
			});
			var doc_cart_card = document.getElementById("cart_card");
			doc_cart_card.innerHTML= cart;
			var doc_sum_price = document.getElementById("sum_price");
			doc_sum_price.innerHTML= sum_price + "円";
			var doc_sum_point = document.getElementById("sum_point");
			doc_sum_point.innerHTML= sum_point + "Ｐ";
		 	});
		}

		function change_recipe_counts(api_recipe_id) {
			var recipe_obj = document.getElementById('recipe_select' + api_recipe_id);
			var recipe_param  = 'user_id='+ user_id +'&recipe_id='+ api_recipe_id +'&recipe_count='+ recipe_obj.value;
			apiResponse('PUT',recipe_apiURI,'',recipe_param,function(data){});
			eval('recipe_foods' + api_recipe_id).forEach(function( foods ){
				var food_param  = 'user_id='+ user_id +'&recipe_id='+ api_recipe_id +'&food_id='+ foods.food_id +'&food_count='+ recipe_obj.value;
				apiResponse('PUT',food_apiURI,'',food_param,function(data){});
			});
			window.timeoutID = window.setTimeout( location.reload(), 500 );
		}

		function change_food_counts(api_recipe_id) {
			eval('recipe_foods' + api_recipe_id).forEach(function( foods ){
				var food_obj = document.getElementById('food_select'+ api_recipe_id +'_'+ foods.food_id);
				var food_param  = 'user_id='+ user_id +'&recipe_id='+ api_recipe_id +'&food_id='+ foods.food_id +'&food_count='+ food_obj.value;
				apiResponse('PUT',food_apiURI,'',food_param,function(data){});
			});
			window.timeoutID = window.setTimeout( location.reload(), 500 );
    }

</script>
</body>
</html>
